name: Release

on:
  push:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Generate version info
  version:
    runs-on: ubuntu-latest
    outputs:
      app_version: ${{ steps.version.outputs.app_version }}
      release_tag: ${{ steps.version.outputs.release_tag }}
    steps:
      - name: Generate version
        id: version
        run: |
          # App version: 0.0.{run_number} - WiX compatible (each component â‰¤ 255)
          APP_VERSION="0.0.${{ github.run_number }}"
          # Release tag: date-based for human readability
          RELEASE_TAG="$(date -u '+%Y%m%d.%H%M')"
          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "App version: $APP_VERSION"
          echo "Release tag: $RELEASE_TAG"

  # Build for all platforms
  build:
    needs: version
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            arch: x64
            platform: windows

          - os: macos-latest
            target: aarch64-apple-darwin
            arch: arm64
            platform: macos

          - os: macos-14
            target: x86_64-apple-darwin
            arch: x64
            platform: macos

          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            arch: x64
            platform: linux

    runs-on: ${{ matrix.os }}
    env:
      APP_VERSION: ${{ needs.version.outputs.app_version }}
      RELEASE_TAG: ${{ needs.version.outputs.release_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libasound2-dev

      - name: Install npm dependencies
        run: npm ci

      - name: Update version in tauri.conf.json
        shell: bash
        run: |
          sed -i.bak 's/"version": "[^"]*"/"version": "${{ env.APP_VERSION }}"/' src-tauri/tauri.conf.json
          cat src-tauri/tauri.conf.json | grep version

      - name: Build Tauri app
        run: npm run tauri build -- --target ${{ matrix.target }}

      - name: Rename artifacts (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          $version = "${{ env.RELEASE_TAG }}"
          $arch = "${{ matrix.arch }}"

          # MSI
          $msi = Get-ChildItem -Path "src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi" | Select-Object -First 1
          $newMsi = "voiceboard-$version-windows-$arch.msi"
          Copy-Item $msi.FullName -Destination $newMsi

          # Create zip
          $exe = "src-tauri/target/${{ matrix.target }}/release/Voiceboard.exe"
          $zip = "voiceboard-$version-windows-$arch.zip"
          Compress-Archive -Path $exe -DestinationPath $zip

      - name: Rename artifacts (macOS)
        if: matrix.platform == 'macos'
        run: |
          VERSION="${{ env.RELEASE_TAG }}"
          ARCH="${{ matrix.arch }}"

          # DMG
          DMG=$(find src-tauri/target/${{ matrix.target }}/release/bundle/dmg -name "*.dmg" | head -1)
          cp "$DMG" "voiceboard-$VERSION-macos-$ARCH.dmg"

          # Create tar.gz from .app
          APP=$(find src-tauri/target/${{ matrix.target }}/release/bundle/macos -name "*.app" -type d | head -1)
          tar -czvf "voiceboard-$VERSION-macos-$ARCH.tar.gz" -C "$(dirname "$APP")" "$(basename "$APP")"

      - name: Rename artifacts (Linux)
        if: matrix.platform == 'linux'
        run: |
          VERSION="${{ env.RELEASE_TAG }}"
          ARCH="${{ matrix.arch }}"

          # AppImage
          APPIMAGE=$(find src-tauri/target/${{ matrix.target }}/release/bundle/appimage -name "*.AppImage" | head -1)
          cp "$APPIMAGE" "voiceboard-$VERSION-linux-$ARCH.AppImage"

          # Create tar.gz
          BINARY="src-tauri/target/${{ matrix.target }}/release/voiceboard"
          tar -czvf "voiceboard-$VERSION-linux-$ARCH.tar.gz" -C "src-tauri/target/${{ matrix.target }}/release" "voiceboard"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: voiceboard-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            voiceboard-*.msi
            voiceboard-*.zip
            voiceboard-*.dmg
            voiceboard-*.tar.gz
            voiceboard-*.AppImage
          if-no-files-found: error

  # Create GitHub Release
  release:
    needs: [version, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum voiceboard-* > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version.outputs.release_tag }}
          name: Voiceboard ${{ needs.version.outputs.release_tag }}
          draft: false
          prerelease: false
          body: |
            ## Voiceboard ${{ needs.version.outputs.release_tag }}

            Automated release from main branch.

            **App Version:** ${{ needs.version.outputs.app_version }}

            ### Downloads

            | Platform | Installer | Archive |
            |----------|-----------|---------|
            | Windows x64 | [.msi](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.release_tag }}/voiceboard-${{ needs.version.outputs.release_tag }}-windows-x64.msi) | [.zip](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.release_tag }}/voiceboard-${{ needs.version.outputs.release_tag }}-windows-x64.zip) |
            | macOS Apple Silicon | [.dmg](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.release_tag }}/voiceboard-${{ needs.version.outputs.release_tag }}-macos-arm64.dmg) | [.tar.gz](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.release_tag }}/voiceboard-${{ needs.version.outputs.release_tag }}-macos-arm64.tar.gz) |
            | macOS Intel | [.dmg](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.release_tag }}/voiceboard-${{ needs.version.outputs.release_tag }}-macos-x64.dmg) | [.tar.gz](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.release_tag }}/voiceboard-${{ needs.version.outputs.release_tag }}-macos-x64.tar.gz) |
            | Linux x64 | [.AppImage](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.release_tag }}/voiceboard-${{ needs.version.outputs.release_tag }}-linux-x64.AppImage) | [.tar.gz](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.release_tag }}/voiceboard-${{ needs.version.outputs.release_tag }}-linux-x64.tar.gz) |

            ### Verification

            Download `SHA256SUMS.txt` and verify:
            ```bash
            sha256sum -c SHA256SUMS.txt
            ```

            ### Notes

            - **Windows**: No code signing - you may see a SmartScreen warning
            - **macOS**: No notarization - right-click and select "Open" to bypass Gatekeeper
            - **Linux**: Make AppImage executable: `chmod +x voiceboard-*.AppImage`
          files: |
            artifacts/voiceboard-*
            artifacts/SHA256SUMS.txt
