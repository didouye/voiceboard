name: Release

on:
  push:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Generate version info
  version:
    runs-on: ubuntu-latest
    outputs:
      app_version: ${{ steps.version.outputs.app_version }}
      release_tag: ${{ steps.version.outputs.release_tag }}
    steps:
      - name: Generate version
        id: version
        run: |
          # App version: 0.0.{run_number} - WiX compatible (each component â‰¤ 255)
          APP_VERSION="0.0.${{ github.run_number }}"
          # Release tag: date-based for human readability
          RELEASE_TAG="$(date -u '+%Y%m%d.%H%M')"
          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "App version: $APP_VERSION"
          echo "Release tag: $RELEASE_TAG"

  # Build for all platforms
  build:
    needs: version
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            arch: x64
            platform: windows

          - os: macos-latest
            target: aarch64-apple-darwin
            arch: arm64
            platform: macos

          - os: macos-14
            target: x86_64-apple-darwin
            arch: x64
            platform: macos

          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            arch: x64
            platform: linux

    runs-on: ${{ matrix.os }}
    env:
      APP_VERSION: ${{ needs.version.outputs.app_version }}
      RELEASE_TAG: ${{ needs.version.outputs.release_tag }}
      TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libasound2-dev

      - name: Install npm dependencies
        run: npm ci

      - name: Update version in tauri.conf.json
        shell: bash
        run: |
          sed -i.bak 's/"version": "[^"]*"/"version": "${{ env.APP_VERSION }}"/' src-tauri/tauri.conf.json
          cat src-tauri/tauri.conf.json | grep version

      - name: Build Tauri app
        run: npm run tauri build -- --target ${{ matrix.target }}

      - name: Rename artifacts (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          $version = "${{ env.RELEASE_TAG }}"
          $arch = "${{ matrix.arch }}"

          # MSI
          $msi = Get-ChildItem -Path "src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi" | Select-Object -First 1
          $newMsi = "voiceboard-$version-windows-$arch.msi"
          Copy-Item $msi.FullName -Destination $newMsi

          # MSI signature (for updater)
          $msiSig = Get-ChildItem -Path "src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi.sig" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($msiSig) {
            Copy-Item $msiSig.FullName -Destination "$newMsi.sig"
          }

          # NSIS zip for updater (if exists)
          $nsisZip = Get-ChildItem -Path "src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.nsis.zip" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($nsisZip) {
            $newNsisZip = "voiceboard-$version-windows-$arch.nsis.zip"
            Copy-Item $nsisZip.FullName -Destination $newNsisZip
            $nsisZipSig = Get-ChildItem -Path "src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.nsis.zip.sig" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($nsisZipSig) {
              Copy-Item $nsisZipSig.FullName -Destination "$newNsisZip.sig"
            }
          }

          # Create zip from exe (for manual download)
          $exe = "src-tauri/target/${{ matrix.target }}/release/Voiceboard.exe"
          $zip = "voiceboard-$version-windows-$arch.zip"
          Compress-Archive -Path $exe -DestinationPath $zip

      - name: Rename artifacts (macOS)
        if: matrix.platform == 'macos'
        run: |
          VERSION="${{ env.RELEASE_TAG }}"
          ARCH="${{ matrix.arch }}"

          # DMG
          DMG=$(find src-tauri/target/${{ matrix.target }}/release/bundle/dmg -name "*.dmg" | head -1)
          cp "$DMG" "voiceboard-$VERSION-macos-$ARCH.dmg"

          # Updater tar.gz and signature (created by Tauri with createUpdaterArtifacts)
          UPDATER_TAR=$(find src-tauri/target/${{ matrix.target }}/release/bundle/macos -name "*.tar.gz" | head -1)
          if [ -n "$UPDATER_TAR" ]; then
            cp "$UPDATER_TAR" "voiceboard-$VERSION-macos-$ARCH.tar.gz"
            if [ -f "${UPDATER_TAR}.sig" ]; then
              cp "${UPDATER_TAR}.sig" "voiceboard-$VERSION-macos-$ARCH.tar.gz.sig"
            fi
          else
            # Fallback: Create tar.gz from .app if updater artifact not found
            APP=$(find src-tauri/target/${{ matrix.target }}/release/bundle/macos -name "*.app" -type d | head -1)
            tar -czvf "voiceboard-$VERSION-macos-$ARCH.tar.gz" -C "$(dirname "$APP")" "$(basename "$APP")"
          fi

      - name: Rename artifacts (Linux)
        if: matrix.platform == 'linux'
        run: |
          VERSION="${{ env.RELEASE_TAG }}"
          ARCH="${{ matrix.arch }}"

          # AppImage
          APPIMAGE=$(find src-tauri/target/${{ matrix.target }}/release/bundle/appimage -name "*.AppImage" | head -1)
          cp "$APPIMAGE" "voiceboard-$VERSION-linux-$ARCH.AppImage"

          # AppImage signature (for updater)
          if [ -f "${APPIMAGE}.sig" ]; then
            cp "${APPIMAGE}.sig" "voiceboard-$VERSION-linux-$ARCH.AppImage.sig"
          fi

          # Updater tar.gz and signature (if created by Tauri)
          UPDATER_TAR=$(find src-tauri/target/${{ matrix.target }}/release/bundle/appimage -name "*.AppImage.tar.gz" | head -1)
          if [ -n "$UPDATER_TAR" ]; then
            cp "$UPDATER_TAR" "voiceboard-$VERSION-linux-$ARCH.tar.gz"
            if [ -f "${UPDATER_TAR}.sig" ]; then
              cp "${UPDATER_TAR}.sig" "voiceboard-$VERSION-linux-$ARCH.tar.gz.sig"
            fi
          else
            # Fallback: Create tar.gz from binary
            tar -czvf "voiceboard-$VERSION-linux-$ARCH.tar.gz" -C "src-tauri/target/${{ matrix.target }}/release" "voiceboard"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: voiceboard-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            voiceboard-*.msi
            voiceboard-*.msi.sig
            voiceboard-*.zip
            voiceboard-*.nsis.zip
            voiceboard-*.nsis.zip.sig
            voiceboard-*.dmg
            voiceboard-*.tar.gz
            voiceboard-*.tar.gz.sig
            voiceboard-*.AppImage
            voiceboard-*.AppImage.sig
          if-no-files-found: error

  # Create GitHub Release
  release:
    needs: [version, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum voiceboard-* > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Generate update manifest
        run: |
          VERSION="${{ needs.version.outputs.release_tag }}"
          APP_VERSION="${{ needs.version.outputs.app_version }}"

          cd artifacts

          # Read signatures from .sig files (they contain base64-encoded signatures)
          read_sig() {
            local sigfile="$1"
            if [ -f "$sigfile" ]; then
              cat "$sigfile"
            else
              echo ""
            fi
          }

          # Get signatures for each platform
          SIG_MACOS_ARM64=$(read_sig "voiceboard-$VERSION-macos-arm64.tar.gz.sig")
          SIG_MACOS_X64=$(read_sig "voiceboard-$VERSION-macos-x64.tar.gz.sig")
          SIG_LINUX_X64=$(read_sig "voiceboard-$VERSION-linux-x64.tar.gz.sig")
          # Windows uses NSIS zip for updater if available, otherwise MSI
          if [ -f "voiceboard-$VERSION-windows-x64.nsis.zip.sig" ]; then
            SIG_WINDOWS_X64=$(read_sig "voiceboard-$VERSION-windows-x64.nsis.zip.sig")
            WINDOWS_URL="https://github.com/${{ github.repository }}/releases/download/v$VERSION/voiceboard-$VERSION-windows-x64.nsis.zip"
          else
            SIG_WINDOWS_X64=$(read_sig "voiceboard-$VERSION-windows-x64.msi.sig")
            WINDOWS_URL="https://github.com/${{ github.repository }}/releases/download/v$VERSION/voiceboard-$VERSION-windows-x64.msi"
          fi

          cat > latest.json << EOF
          {
            "version": "$APP_VERSION",
            "notes": "Voiceboard $VERSION - Automated release",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "darwin-aarch64": {
                "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/voiceboard-$VERSION-macos-arm64.tar.gz",
                "signature": "$SIG_MACOS_ARM64"
              },
              "darwin-x86_64": {
                "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/voiceboard-$VERSION-macos-x64.tar.gz",
                "signature": "$SIG_MACOS_X64"
              },
              "linux-x86_64": {
                "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/voiceboard-$VERSION-linux-x64.tar.gz",
                "signature": "$SIG_LINUX_X64"
              },
              "windows-x86_64": {
                "url": "$WINDOWS_URL",
                "signature": "$SIG_WINDOWS_X64"
              }
            }
          }
          EOF

          echo "=== Generated latest.json ==="
          cat latest.json
          cd ..

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version.outputs.release_tag }}
          name: Voiceboard ${{ needs.version.outputs.release_tag }}
          draft: false
          prerelease: false
          body: |
            ## Voiceboard ${{ needs.version.outputs.release_tag }}

            Automated release from main branch.

            **App Version:** ${{ needs.version.outputs.app_version }}

            ### Downloads

            | Platform | Installer | Archive |
            |----------|-----------|---------|
            | Windows x64 | [.msi](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.release_tag }}/voiceboard-${{ needs.version.outputs.release_tag }}-windows-x64.msi) | [.zip](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.release_tag }}/voiceboard-${{ needs.version.outputs.release_tag }}-windows-x64.zip) |
            | macOS Apple Silicon | [.dmg](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.release_tag }}/voiceboard-${{ needs.version.outputs.release_tag }}-macos-arm64.dmg) | [.tar.gz](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.release_tag }}/voiceboard-${{ needs.version.outputs.release_tag }}-macos-arm64.tar.gz) |
            | macOS Intel | [.dmg](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.release_tag }}/voiceboard-${{ needs.version.outputs.release_tag }}-macos-x64.dmg) | [.tar.gz](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.release_tag }}/voiceboard-${{ needs.version.outputs.release_tag }}-macos-x64.tar.gz) |
            | Linux x64 | [.AppImage](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.release_tag }}/voiceboard-${{ needs.version.outputs.release_tag }}-linux-x64.AppImage) | [.tar.gz](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.release_tag }}/voiceboard-${{ needs.version.outputs.release_tag }}-linux-x64.tar.gz) |

            ### Verification

            Download `SHA256SUMS.txt` and verify:
            ```bash
            sha256sum -c SHA256SUMS.txt
            ```

            ### Notes

            - **Windows**: No code signing - you may see a SmartScreen warning
            - **macOS**: No notarization - right-click and select "Open" to bypass Gatekeeper
            - **Linux**: Make AppImage executable: `chmod +x voiceboard-*.AppImage`
          files: |
            artifacts/voiceboard-*
            artifacts/SHA256SUMS.txt
            artifacts/latest.json
